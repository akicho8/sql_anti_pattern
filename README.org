* SQLアンチパターン覚え書き

   | 名前                   | 何がダメか                           | 解決方法                   |
   |------------------------+--------------------------------------+----------------------------|
   | 信号無視               | 1つのカラムにIDを複数格納            | 中間テーブルを持つ         |
   | 複数列属性             | 面倒なのでカラムを連番で増やしていく | 1:多の適切なリレーション   |
   | 闇雲インデックス       | すべてにインデックスを張る           | 絞る                       |
   | 幻のファイル           | カラムに画像ファイルのパスを格納     | blob                       |
   | 読み取り可能パスワード | パスワードをそのまま格納             | ハッシュ化                 |
   | 31のフレーバー         | 限定する値を列定義(enum)で指定       | 別テーブルで管理           |
   | ランダムセレクション   | order rand()                         | limit 1 offset rand(count) |
   | 丸め誤差               | float                                | decimal                    |
   | SQLインジェクション    | where("id = #{params[:id]}")         | where(:id => params[:id])  |

** [[jaywalking.rb][信号無視]]

# #+INCLUDE: "jaywalking.rb" ruby
# #+INCLUDE: "https://raw.githubusercontent.com/akicho8/sql_anti_pattern/master/jaywalking.rb" ruby
# #+INCLUDE: "jaywalking.rb" example

#+BEGIN_SRC ruby
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.string :friends_ids
  end
end

class User < ActiveRecord::Base
  def friends
    User.find(friends_ids.scan(/\d+/))
  end
end

user = User.create!
user.friends_ids = 2.times.collect { User.create!.id }.join(",")
user.friends_ids # => "2,3"
user.friends     # => [#<User id: 2, friends_ids: nil>, #<User id: 3, friends_ids: nil>]
#+END_SRC

** [[multi_column_attribute.rb][複数列属性]]

#+BEGIN_SRC ruby
create_table :users do |t|
  t.string :profile_image1
  t.string :profile_image2
  t.string :profile_image3
end
#+END_SRC

** [[index_shotgun.rb][闇雲インデックス]]

#+BEGIN_SRC ruby
# 張ればいいというもんではない
ActiveRecord::Schema.define do
  create_table :articles do |t|
    t.string :name
    t.string :message
    t.timestamps

    t.index :id
    t.index :name
    t.index :message
    t.index [:message, :name]
    t.index [:id, :message, :name, :created_at, :updated_at], :unique => true, :name => :all
  end
end
#+END_SRC

** [[phantom_files.rb][幻のファイル]]

#+BEGIN_SRC ruby
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.string :profile_image_path
  end
end

user = User.create!(:profile_image_path => "path/to/profile.png") # => #<User id: 1, profile_image_path: "path/to/profile.png">
#+END_SRC

** [[readable_passwords.rb][読み取り可能パスワード]]

#+BEGIN_SRC ruby
user = User.create!(:password => "password")
user.password_before_type_cast  # => "password"
#+END_SRC

** [[thirty_one_flavors.rb][31のフレーバー]]

#+BEGIN_SRC ruby
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.column :foo, "ENUM('a', 'b')"
  end
end

User.create!(:foo => "a") # => #<User id: 1, foo: "a">
User.create!(:foo => "b") # => #<User id: 2, foo: "b">
#+END_SRC

** [[random_selection.rb][ランダムセレクション]]

#+BEGIN_SRC ruby
# NG
User.order("random()").take

# GOOD
User.offset(rand(User.count)).take
#+END_SRC

** [[rounding_errors.rb][丸め誤差]]

#+BEGIN_SRC ruby
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.column :c1, :float
    t.column :c2, :double
    t.column :c3, "DECIMAL(65, 30)"
  end
end

v = 5.5555555555555555555555555555555555555
user = User.create!(:c1 => v, :c2 => v, :c3 => v).reload
user.c1.to_d # => 0.555556e1
user.c2.to_d # => 0.555555555555556e1
user.c3.to_d # => 0.5555555555555555e1
#+END_SRC

** [[sql_injection.rb][SQLインジェクション]]

#+BEGIN_SRC ruby
id = "0 or name = 'admin'"
User.where("id = #{id}").take   # => #<User id: 2, name: "admin">
#+END_SRC
